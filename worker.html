<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - CipherCoin Team</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
<style>
:root { --primary-color: #0d6efd; --dark-color: #212529; --light-color: #f8f9fa; --white-color: #fff; --danger-color: #dc3545; --success-color: #198754; --warning-color: #ffc107; }
body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background-color: var(--light-color); }
h1, h2, h3, h4 { margin: 0; }
h1 { font-size: 1.2rem; }
h2 { font-size: 1.2rem; margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
h3 { font-size: 1.1rem; margin-bottom: 1rem; }
.header { background-color: var(--primary-color); color: var(--white-color); padding: 1rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1020; }
.header-title-group { display: flex; flex-direction: column; align-items: flex-start; }
.header-title-group span { font-size: 0.8rem; opacity: 0.8; }
.icon-btn { background: none; border: none; color: var(--white-color); font-size: 1.5rem; cursor: pointer; }
.container { padding: 1rem; }
.card { background: var(--white-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 1.5rem; padding: 1.5rem; }
.form-group { margin-bottom: 1rem; }
label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
input[type="number"], input[type="text"] { font-size: 1rem; padding: 0.75rem; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
.btn { padding: 0.75rem 1rem; border-radius: 8px; border: none; color: var(--white-color); cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
.btn-primary { background-color: var(--primary-color); }
.btn-success { background-color: var(--success-color); }
.btn-danger { background-color: var(--danger-color); }
.btn:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.7; }
.status { font-weight: bold; margin-left: 1rem; }
.status.present { color: var(--success-color); }
.status.absent { color: var(--danger-color); }
.status.pending { color: var(--warning-color); }
#nav-menu { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background-color: var(--dark-color); z-index: 1030; transition: left 0.3s ease; padding-top: 4rem; }
#nav-menu a { display: block; padding: 1rem 1.5rem; color: var(--white-color); text-decoration: none; font-size: 1.1rem; border-bottom: 1px solid #444; }
#overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1010; }
.credit-balance { font-size: 2rem; font-weight: 700; color: var(--primary-color); }
.task-description { font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem; }
.empty-state { text-align: center; padding: 1.5rem; color: #6c757d; font-weight: 500; }
.success-message { display: none; padding: 0.75rem; margin-top: 1rem; border-radius: 8px; background-color: #e8f5e9; color: var(--success-color); font-weight: 500; display: flex; align-items: center; gap: 0.5rem; }
.success-message i { color: var(--success-color); }
</style>
<script src="//cdn.jsdelivr.net/npm/eruda"></script><script>eruda.init();</script>
</head>
<body>
<div id="nav-menu">
    <a href="history.html?type=attendance"><i class="fas fa-calendar-check fa-fw"></i> My Attendance</a>
    <a href="history.html?type=reports"><i class="fas fa-file-alt fa-fw"></i> My Reports</a>
    <a href="history.html?type=withdrawals"><i class="fas fa-history fa-fw"></i> My Withdrawals</a>
    <a href="#" id="logoutBtnNav"><i class="fas fa-sign-out-alt fa-fw"></i> Logout</a>
</div>
<div id="overlay"></div>
<div class="header">
    <div class="header-title-group"><h1 id="welcomeMsg">Welcome!</h1><span>CipherCoin Team</span></div>
    <button id="menu-btn" class="icon-btn"><i class="fas fa-bars"></i></button>
</div>

<div class="container">
    <div class="card">
        <h2><i class="fas fa-wallet"></i> My Wallet</h2>
        <p>Available Credits: <span id="credit-balance" class="credit-balance">0</span></p>
    </div>

    <div class="card">
        <h2>
            <i class="fas fa-clock"></i>
            <span>Today's Attendance</span>
            <span id="attendance-date" style="font-size: 0.9rem; font-weight: normal; margin-left: auto;"></span>
        </h2>
        <p>(6 AM - 11 AM): <button id="morningBtn" class="btn btn-primary" disabled>Mark</button><span id="morningStatus" class="status"></span></p>
        <p>(3 PM - 1 AM): <button id="eveningBtn" class="btn btn-primary" disabled>Mark</button><span id="eveningStatus" class="status"></span></p>
    </div>

    <div class="card">
        <h2><i class="fas fa-bullhorn"></i> New Tasks</h2>
        <div id="newTasksContainer">
            <p id="loader-tasks" class="empty-state">Loading tasks...</p>
        </div>
    </div>

    <div class="card">
        <h2><i class="fas fa-edit"></i> Submit Daily Report</h2>
        <form id="dailyReportForm">
            <div class="form-grid" style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                <div class="form-group"><label>Mixing screenshots shared:</label><input type="number" id="mixing_screenshots" min="0" required></div>
                <div class="form-group"><label>Withdrawal records shared:</label><input type="number" id="withdrawal_records" min="0" required></div>
                <div class="form-group"><label>Sentences on Telegram:</label><input type="number" id="telegram_sentences" min="0" required></div>
                <div class="form-group"><label>Sentences on WhatsApp:</label><input type="number" id="whatsapp_sentences" min="0" required></div>
                <div class="form-group"><label>New people talked to:</label><input type="number" id="new_people_talked" min="0" required></div>
                <div class="form-group"><label>New people joined:</label><input type="number" id="new_people_registered" min="0" required></div>
                <div class="form-group"><label>Total deposit by new people:</label><input type="number" id="new_people_deposit" min="0" required></div>
            </div>
            <button type="submit" class="btn btn-success" style="width: 100%;">Submit Report</button>
        </form>
        <div id="reportSuccessMsg" class="success-message"></div>
    </div>

    <div class="card">
        <h2><i class="fas fa-money-bill-wave"></i> Request Withdrawal</h2>
        <p style="font-size: 0.9rem; color: #6c757d;">Minimum 500 credits required.</p>
        <div class="form-group"><input type="number" id="withdraw-amount" placeholder="Enter amount" min="0"></div>
        <button id="request-withdrawal-btn" class="btn btn-primary" style="width: 100%;" disabled>Request</button>
        <div id="withdrawalSuccessMsg" class="success-message"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp, onSnapshot, collection, query, where, getDocs, writeBatch, increment, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    const firebaseConfig = { apiKey: "AIzaSyAQk4RNMXrJgQXW0OMWbNINhl1HCdYRqZc", authDomain: "cipher-coin-team.firebaseapp.com", projectId: "cipher-coin-team", storageBucket: "cipher-coin-team.firebasestorage.app", messagingSenderId: "1061225842169", appId: "1:1061225842169:web:e36f7e8e9a07eba6fb2928" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let loggedInUser = null;
    let userCreditBalance = 0;

    function showSuccessMessage(elementId, message, duration = 4000) {
        const el = document.getElementById(elementId);
        if (!el) return;
        el.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        el.style.display = 'flex';
        if (duration > 0) {
            setTimeout(() => { el.style.display = 'none'; }, duration);
        }
    }

    function getISTDateTime() {
        const now = new Date();
        const date = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
        const dateString = date.toISOString().slice(0, 10);
        const hour = date.getHours();
        return { date, dateString, hour };
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (loggedInUser && loggedInUser.uid === user.uid) {
                initializeDashboard();
            } else { logout(); }
        } else { window.location.href = 'index.html'; }
    });

    const menuBtn = document.getElementById('menu-btn'), navMenu = document.getElementById('nav-menu'), overlay = document.getElementById('overlay');
    menuBtn.addEventListener('click', () => { navMenu.style.left = '0'; overlay.style.display = 'block'; });
    overlay.addEventListener('click', () => { navMenu.style.left = '-280px'; overlay.style.display = 'none'; });
    const logout = () => { signOut(auth).then(() => sessionStorage.clear()); };
    document.getElementById('logoutBtnNav').addEventListener('click', logout);
    
    function setupWallet() {
        if (!loggedInUser) return;
        onSnapshot(doc(db, "users", loggedInUser.uid), (doc) => {
            if (!doc.exists()) return;
            userCreditBalance = doc.data().credits || 0;
            document.getElementById('credit-balance').textContent = userCreditBalance;
            const withdrawBtn = document.getElementById('request-withdrawal-btn');
            const withdrawAmountInput = document.getElementById('withdraw-amount');
            withdrawBtn.disabled = userCreditBalance < 500 || Number(withdrawAmountInput.value) <= 0;
        });
    }

    async function requestWithdrawal() {
        const amountInput = document.getElementById('withdraw-amount');
        const amount = Number(amountInput.value);
        if (amount <= 0 || amount > userCreditBalance || amount < 500) {
            alert("Invalid withdrawal amount. Must be at least 500 and not more than your balance.");
            return;
        }
        const btn = document.getElementById('request-withdrawal-btn');
        btn.disabled = true;
        btn.textContent = 'Processing...';
        try {
            const batch = writeBatch(db);
            const userRef = doc(db, "users", loggedInUser.uid);
            const withdrawalRef = doc(collection(db, "withdrawals"));
            batch.update(userRef, { credits: increment(-amount) });
            batch.set(withdrawalRef, {
                workerId: loggedInUser.uid,
                workerName: loggedInUser.name,
                amount: amount,
                status: 'pending',
                requestedAt: serverTimestamp()
            });
            await batch.commit();
            showSuccessMessage('withdrawalSuccessMsg', `Withdrawal request of ${amount} credits submitted.`);
            amountInput.value = '';
        } catch (error) {
            alert("Could not process withdrawal. Please try again.");
            console.error("Withdrawal error:", error);
        } finally {
            btn.textContent = 'Request';
        }
    }

    async function updateAttendanceUI() {
        const { date, dateString, hour } = getISTDateTime();
        document.getElementById('attendance-date').textContent = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long' });

        async function isSessionMarked(session, relevantDate) {
            try {
                const docId = `${loggedInUser.uid}_${relevantDate}_${session}`;
                const docSnap = await getDoc(doc(db, "attendance", docId));
                return docSnap.exists();
            } catch (error) {
                console.error(`Permission error checking attendance for ${session}, or other error:`, error);
                return false;
            }
        }

        const morningBtn = document.getElementById('morningBtn');
        const morningStatus = document.getElementById('morningStatus');
        const morningMarked = await isSessionMarked('morning', dateString);
        if (morningMarked) {
            morningBtn.disabled = true;
            morningBtn.textContent = "Marked";
            morningStatus.className = "status present";
            morningStatus.textContent = "You're Present";
        } else {
            const isWindowActive = hour >= 6 && hour < 11;
            morningBtn.disabled = !isWindowActive;
            morningBtn.textContent = "Mark";
            if (!isWindowActive) {
                const isWindowOver = hour >= 11;
                morningStatus.textContent = isWindowOver ? "Time Over" : "Not Yet Started";
                morningStatus.className = isWindowOver ? "status absent" : "status pending";
            } else {
                morningStatus.textContent = "";
            }
        }

        const eveningBtn = document.getElementById('eveningBtn');
        const eveningStatus = document.getElementById('eveningStatus');
        let relevantEveningDate = dateString;
        if (hour < 15) {
            const yesterday = new Date(date);
            yesterday.setDate(yesterday.getDate() - 1);
            relevantEveningDate = yesterday.toISOString().slice(0, 10);
        }
        const eveningMarked = await isSessionMarked('evening', relevantEveningDate);
        if (eveningMarked) {
            eveningBtn.disabled = true;
            eveningBtn.textContent = "Marked";
            eveningStatus.className = "status present";
            eveningStatus.textContent = "You're Present";
        } else {
            const isWindowActive = hour >= 15 || hour < 1;
            eveningBtn.disabled = !isWindowActive;
            eveningBtn.textContent = "Mark";
            if (!isWindowActive) {
                const isWindowOver = hour >= 1 && hour < 15;
                eveningStatus.textContent = isWindowOver ? "Time Over" : "Not Yet Started";
                eveningStatus.className = isWindowOver ? "status absent" : "status pending";
            } else {
                eveningStatus.textContent = "";
            }
        }
    }

    async function markAttendance(session) {
        const btn = document.getElementById(`${session}Btn`);
        btn.disabled = true;
        const { date, hour } = getISTDateTime();
        let relevantDate = date.toISOString().slice(0, 10);
        if (session === 'evening' && hour < 1) {
            let yesterday = new Date(date);
            yesterday.setDate(yesterday.getDate() - 1);
            relevantDate = yesterday.toISOString().slice(0, 10);
        }
        try {
            await setDoc(doc(db, "attendance", `${loggedInUser.uid}_${relevantDate}_${session}`), {
                workerId: loggedInUser.uid, workerName: loggedInUser.name, date: relevantDate, session, timestamp: serverTimestamp()
            });
            await updateAttendanceUI();
        } catch (error) {
            alert(`Could not mark attendance. Error: ${error.message}`);
            btn.disabled = false;
        }
    }
    
    async function renderNewTasks() {
        if (!loggedInUser) return;
        const loader = document.getElementById('loader-tasks');
        const container = document.getElementById('newTasksContainer');
        loader.style.display = 'block';
        container.innerHTML = '';
        const { dateString } = getISTDateTime();
        
        const tasksQuery = query(collection(db, "tasks"), where("status", "==", "active"), orderBy("createdAt", "desc"));
        const submissionsQuery = query(collection(db, "task_submissions"), where("workerId", "==", loggedInUser.uid), where("date", "==", dateString));
        try {
            const [tasksSnapshot, submissionsSnapshot] = await Promise.all([ getDocs(tasksQuery), getDocs(submissionsSnapshot) ]);
            const submittedTaskIds = new Set(submissionsSnapshot.docs.map(doc => doc.data().taskId));
            
            let hasUnsubmittedTasks = false;
            tasksSnapshot.forEach(d => {
                const task = d.data();
                const isSubmitted = submittedTaskIds.has(d.id);
                if (!isSubmitted) {
                    hasUnsubmittedTasks = true;
                }
                container.innerHTML += `
                    <div style="border-bottom: 1px solid #eee; padding-bottom: 1rem; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.25rem 0;">${task.title} <span style="font-weight:normal; color: var(--success-color);">(${task.credits} Credits)</span></h4>
                        <p class="task-description">${task.description}</p>
                        <button class="btn btn-primary" style="margin-top: 0.5rem;" ${isSubmitted ? 'disabled' : ''} data-action="submit-task" data-id="${d.id}" data-title="${task.title}" data-credits="${task.credits}">
                            ${isSubmitted ? '<i class="fas fa-check"></i> Submitted Today' : 'Submit for Review'}
                        </button>
                    </div>`;
            });

            if (!hasUnsubmittedTasks) {
                 container.innerHTML = '<p class="empty-state">No new tasks available.</p>';
            }

        } catch (error) {
            console.error("Failed to render tasks:", error);
            container.innerHTML = `<p class="empty-state" style="color: var(--danger-color);">Could not load tasks. Please ensure the database index is created.</p>`;
        } finally {
            loader.style.display = 'none';
        }
    }
    
    async function setupDailyReport() {
        if (!loggedInUser) return;
        const { dateString } = getISTDateTime();
        const docSnap = await getDoc(doc(db, "daily_reports", `${loggedInUser.uid}_${dateString}`));
        if (docSnap.exists()) {
            document.getElementById('dailyReportForm').style.display = 'none';
            showSuccessMessage('reportSuccessMsg', 'Your report for today has already been submitted.', 0);
        }
    }

    async function handleReportSubmit(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button'); btn.disabled = true;
        try {
            const { dateString } = getISTDateTime();
            const reportData = { workerId: loggedInUser.uid, workerName: loggedInUser.name, date: dateString, status: 'pending', submittedAt: serverTimestamp(), mixing_screenshots: Number(document.getElementById('mixing_screenshots').value), withdrawal_records: Number(document.getElementById('withdrawal_records').value), telegram_sentences: Number(document.getElementById('telegram_sentences').value), whatsapp_sentences: Number(document.getElementById('whatsapp_sentences').value), new_people_talked: Number(document.getElementById('new_people_talked').value), new_people_registered: Number(document.getElementById('new_people_registered').value), new_people_deposit: Number(document.getElementById('new_people_deposit').value) };
            await setDoc(doc(db, "daily_reports", `${loggedInUser.uid}_${dateString}`), reportData);
            document.getElementById('dailyReportForm').style.display = 'none';
            showSuccessMessage('reportSuccessMsg', "Daily report submitted successfully!", 0);
        } catch (error) {
            alert(`Could not submit report. Error: ${error.message}`);
            btn.disabled = false;
        }
    }

    function initializeDashboard() {
        document.getElementById('welcomeMsg').textContent = `Welcome, ${loggedInUser.name}!`;
        document.getElementById('morningBtn').addEventListener('click', () => markAttendance('morning'));
        document.getElementById('eveningBtn').addEventListener('click', () => markAttendance('evening'));
        document.getElementById('dailyReportForm').addEventListener('submit', handleReportSubmit);
        document.getElementById('request-withdrawal-btn').addEventListener('click', requestWithdrawal);
        document.getElementById('withdraw-amount').addEventListener('input', (e) => {
            const amount = Number(e.target.value);
            document.getElementById('request-withdrawal-btn').disabled = userCreditBalance < 500 || amount <= 0 || amount > userCreditBalance;
        });
        document.addEventListener('click', async e => {
            if (e.target.dataset.action === 'submit-task') {
                const btn = e.target;
                const { id, title, credits } = btn.dataset;
                btn.disabled = true;
                try {
                    const { dateString } = getISTDateTime();
                    await addDoc(collection(db, "task_submissions"), {
                        workerId: loggedInUser.uid,
                        workerName: loggedInUser.name,
                        taskId: id,
                        taskTitle: title,
                        credits: Number(credits),
                        date: dateString,
                        status: 'pending',
                        submittedAt: serverTimestamp()
                    });
                    btn.innerHTML = '<i class="fas fa-check"></i> Submitted Today';
                } catch (error) {
                    alert('Could not submit task. Please try again.');
                    btn.disabled = false;
                }
            }
        });
        setupWallet();
        updateAttendanceUI();
        setupDailyReport();
        renderNewTasks();
        setInterval(updateAttendanceUI, 60000);
    }
</script>
</body>
</html>
